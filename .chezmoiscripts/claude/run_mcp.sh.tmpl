{{ if eq .chezmoi.os "darwin" "linux" -}}
#!/bin/bash
set -euo pipefail

{{ $mcp_servers_json := .claude.mcpServers |
    pruneEmptyDicts |
    toJson |
    -}}

tmp_payload=$(mktemp)
cat >"$tmp_payload" <<'JSON'
{{ $mcp_servers_json }}
JSON

original_claude_json_path="$XDG_CONFIG_HOME/claude/.claude.json"
current_claude_json_copy_path=$(mktemp)

# ensure the temporary files are removed on script exit
trap 'rm -f "$tmp_payload" "$current_claude_json_copy_path"' EXIT

# Early exit if jq is not installed
if ! type jq >/dev/null 2>&1; then
    echo "‚ùå jq is not available. Exiting..."
    exit 1
fi

if [ ! -f "$original_claude_json_path" ]; then
    echo "üöß $original_claude_json_path not found. touching it to create an empty file..."
    echo "{}\n" >"$original_claude_json_path"
fi

# replace the mcpServers field in ~/.config/claude/.claude.json with the new payload file
# shellcheck disable=SC2154
if jq --slurpfile mcpServers "$tmp_payload" '.mcpServers = $mcpServers[0]' \
    "$original_claude_json_path" >"$current_claude_json_copy_path" &&
    mv "$current_claude_json_copy_path" "$original_claude_json_path"; then
    echo "‚úÖ Successfully updated mcpServers in $original_claude_json_path"
else
    echo "‚ùå Failed to update mcpServers in $original_claude_json_path"
    exit 1
fi
{{ end -}}
