[include]
path = ~/.config/git/config.d/one-password.conf
path = ~/.config/git/config.d/github.conf

[includeIf "gitdir:~/workspace/codeberg.org/"]
path = ~/.config/git/config.d/codeberg.conf

[branch]
sort = -committerdate

[color]
ui = true
grep = auto
diff = auto
status = auto
branch = auto

[column]
ui = auto

[commit]
verbose = true

[core]
autocrlf = input
fsmonitor = true
ignorecase = false
pager = delta
untrackedCache = true

[delta]
navigate = true

[diff]
algorithm = histogram
colorMoved = true
external = difft
mnemonicPrefix = true
renames = true
submodule = log

[fetch]
prune = true
pruneTags = true
all = true

[feature]
experimental = true

[help]
autocorrect = prompt

[init]
defaultBranch = main

[interactive]
diffFilter = delta --color-only

[merge]
conflictStyle = zdiff3

[push]
autoSetupRemote = true
default = simple
followTags = true
useForceIfIncludes = true

[pull]
autoStash = true
ff = only
rebase = true

[rebase]
autoStash = true
autoSquash = true
updateRefs = true

[rerere]
autoupdate = true
enabled = true

[status]
submoduleSummary = true

[submodule]
recurse = true

[tag]
sort = version:refname

[filter "lfs"]
process = git-lfs filter-process
required = true
clean = git-lfs clean -- %f
smudge = git-lfs smudge -- %f

[alias]
# shorthand
f = "fetch"
s = "status"
alias = "!f() { git config --get-regexp '^alias' | sed 's/^alias\\.//g'; }; f"
fixit = "commit --amend --no-edit"
cz = "!f() { git-cz }; f"

# primitive
default-branch-origin = "symbolic-ref --quiet --short refs/remotes/origin/HEAD"
default-branch = "!f() { git default-branch-origin | sed 's@^origin/@@'; }; f"
current-branch = "branch --show-current"

swc = "!f() { \
    suffix=\"${1:+-$1}\"; \
    owner=$(git remote get-url origin 2>/dev/null | sed -E 's#.*[:/]([^/]+)/[^/]+(\\.git)?$#\\1#'); \
    prefix=$([ \"$owner\" = \"$USER\" ] && echo \"\" || echo \"$USER-\"); \
    git switch -c \"${prefix}$(TZ=UTC-9 date +'%Y%m%d%H%M')$suffix\"; \
}; f"
clear-cache = "rm -r --cached ."
com = "!f() { \
    DEFAULT_BRANCH=$(git default-branch); \
    git switch \"$DEFAULT_BRANCH\"; \
}; f"
bk = "!f() { \
    CURRENT_BRANCH=$(git branch --show-current); \
    BACKUP_BRANCH_NAME=\"${CURRENT_BRANCH}-$(TZ=UTC-9 date +'%Y%m%d%H%M')\"; \
    git switch -c \"$BACKUP_BRANCH_NAME\"; \
}; f"

# rebase current branch with origin/HEAD
rbm = "!f() { \
    CURRENT_BRANCH=$(git branch --show-current); \
    git stash push --include-untracked -m \"Auto stash before rebase of $CURRENT_BRANCH\"; \
    git fetch origin && git rebase origin/HEAD && git stash pop || { echo 'Conflict occurred during rebase. Please run $(git rebase --continue) and then $(git stash pop) after resolving conflicts.'; return 1; }; \
}; f"

get-ancestor-commit= "!f() { \
    DEFAULT_BRANCH=$(git default-branch); \
    git merge-base HEAD $DEFAULT_BRANCH; \
}; f"
diff-ancestor-commit = "!f() { \
    ANCESTOR_COMMIT=$(git merge-base HEAD $(git default-branch)); \
    git diff $ANCESTOR_COMMIT; \
}; f"
dd = "!f() { \
    CURRENT_BRANCH=$(git branch --show-current); \
    DEFAULT_BRANCH=$(git default-branch); \
    git diff --stat $DEFAULT_BRANCH..$CURRENT_BRANCH; \
}; f"
